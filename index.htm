<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--not require css/fonts-->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,600,700" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <!--grid css-->
    <link rel="stylesheet" href="css/libs/gridstack.min.css"/>
    <link rel="stylesheet" href="css/libs/gridstack-extra.min.css"/>
    <!--our styles for dashboard and widgets-->
    <link rel="stylesheet" href="css/dashboard/dashboard.min.css">
    <!--grid require-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.11.0/jquery-ui.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.5.0/lodash.min.js"></script>
    <!--grid js-->
    <script src="scripts/libs/gridstack.min.js"></script>
    <script src="scripts/libs/gridstack.jQueryUI.min.js"></script>

    <!--for timezone-->
    <script src="scripts/libs/moment.js"></script>
    <script src="scripts/libs/moment-timezone-with-data-2012-2022.js"></script>
    <!--our main js-->
    <script src="scripts/dashboard/main.js"></script>

    <title>Widgets Demo</title>
</head>

<body>


<div class="dashboard">
    <label>Edit <input type="checkbox" id="editMode"></label>
    <div class="dashboardEditPanel" id="dashboardEditPanel">
        <div class="sidebar"></div>
    </div>
    <div class="grid-stack grid-stack-12" id="grid1"></div>
</div>


<script type="text/javascript">
    $(() => {
        // data
        let
            isEditMode = false,
            clientId = 7,
            widgetConfig = [
                {
                    widget: "clockWidget",
                    id: "clockWidget",
                    title: 'Clock',
                    withDatePicker: false,
                    isConfigurable: true
                },
                {
                    widget: "imageWidget2",
                    id: "imageWidget",
                    title: 'Unlim images',
                    imageUrl: 'https://www.google.com/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png',
                    count: "unlimited"  // number or string = "unlimited"
                },
                {
                    widget: "workCountByActivityAndStatusWidget",
                    id: "workCountByActivityAndStatusWidget",
                    title: 'Collections',
                    activityTypeId: 19,
                    workStatusId: 3,
                    count: 3
                },
                {
                    widget: "imageWidget1",
                    id: "imageWidget",
                    minWidth: 2,
                    minHeight: 1,
                    title: 'Techfinity Logo',
                    isResizable: false,
                    defaultWidget: true,
                    x: 6,
                    y: 2,
                    isRemovable: false
                }
            ],
            mainGrid = $('#grid1'),
            localStorage = window.localStorage,
            widgetsToSave = {
                activeWidgetList: [],
                activeWidgets: []
            },
            widgetsBeforeRemove = [];

        // dashboard activation
        mainGrid.gridstack({
            width: 12,
            float: true,
            acceptWidgets: '.grid-stack-item'
        });

        renderAfterReload();
        widgetListCall();
        allowMoveAndResizeItems(isEditMode);
        handleEvents();

        // item for render
        function gridItem(dataAttr, title, count = '') {

            if (count === "unlimited") {
                count = ''
            }

            return $('<div class="grid-stack-item" data-widget="' + dataAttr + '"><div class="grid-stack-item-content" data-widget="' + dataAttr + '"><div class="widget-content"  data-widget-count="' + count + '">' + title + '</div>' +
                '</div></div></div></div></div></div>');
        }

        //count of active instances
        function getCountActiveIstances(widget) {
            return getActiveWidgets().filter((item) => {
                return item === widget
            }).length;
        }

        // first render
        function renderAfterReload() {
            if (localStorage.getItem('widgets') === null || JSON.parse(localStorage.getItem('widgets')).length === 0) {
                let widgetsDefault = [];
                widgetConfig.forEach((item) => {
                    // render default widgets
                    if (typeof item.defaultWidget !== "undefined" && item.defaultWidget) {
                        widgetsDefault.push(item);
                    } else {
                        // if not default, add to widgets list
                        if (typeof item.count !== 'undefined' && item.count > 0) {
                            $('.sidebar').append(gridItem(item.widget, item.title, item.count));
                        } else {
                            $('.sidebar').append(gridItem(item.widget, item.title));
                        }
                    }
                });
                if (widgetsDefault.length > 0) {
                    renderActiveWidgets(widgetsDefault);
                }
            } else {
                let widgetsFromStore = JSON.parse(localStorage.getItem('widgets')),
                    list = widgetsFromStore.activeWidgetList,
                    activeWidgets = widgetsFromStore.activeWidgets;

                if (typeof activeWidgets !== 'undefined' && activeWidgets.length > 0) {
                    renderActiveWidgets(activeWidgets);
                }

                if (typeof list !== 'undefined' && list.length > 0) {
                    list.forEach((key) => {
                        widgetConfig.forEach((item) => {
                            if (item.widget === key) {
                                if (typeof item.count !== 'undefined' && item.count > 0) {
                                    $('.sidebar').append(gridItem(key, item.title, item.count - getCountActiveIstances(item.widget)))
                                } else {
                                    $('.sidebar').append(gridItem(key, item.title))
                                }
                            }
                        });

                    });
                }
            }
        }

        // renderActiveWidgets
        function renderActiveWidgets(activeWidgets) {
            activeWidgets.forEach((key) => {
                let activeParams = key,
                    localParams = widgetConfig.filter((item) => {
                        return item.widget === key.widget
                    })[0],
                    el = gridItem(key.widget, key.title);
                if (typeof activeParams.defaultWidget !== 'undefined' && activeParams.defaultWidget) {
                    activeParams = localParams;
                }

                let minWidth, minHeight, maxWidth, maxHeight;

                if (typeof localParams.minWidth !== "undefined") {
                    minWidth = localParams.minWidth;
                }
                if (typeof localParams.minHeight !== "undefined") {
                    minHeight = localParams.minHeight;
                }
                if (typeof localParams.maxWidth !== "undefined") {
                    maxWidth = localParams.maxWidth;
                }
                if (typeof localParams.maxHeight !== "undefined") {
                    maxHeight = localParams.maxHeight;
                }
                let newItem = mainGrid.data("gridstack").addWidget(
                    el,
                    activeParams.x,
                    activeParams.y,
                    activeParams.width,
                    activeParams.height,
                    false,
                    minWidth,
                    maxWidth,
                    minHeight,
                    maxHeight,
                    true
                );

                if (typeof localParams.isResizable !== 'undefined' && !localParams.isResizable) {
                    mainGrid.data("gridstack").resizable(newItem, localParams.isResizable);
                }
                el[0].children[0].children[0].innerHTML = '<div class="widget-loading-container"><div class="widget-loading">' +
                    '<div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div>';


                // init
                widgetConfig.forEach((itemName) => {
                    if (itemName.widget === key.widget) {
                        Widget.widgetInitializer(itemName).initBase(el[0].children[0].children[0], clientId);
                    }
                });
            });
        }

        function saveWidgetItems() {
            let grid = mainGrid.data("gridstack").grid,
                activeWidgets = [];
            setTimeout(() => {
                for (let i = 0; grid.nodes.length > i; i++) {
                    let
                        widgetId = grid.nodes[i].el[0].children[0].dataset.widget,
                        itemData = grid.nodes[i].el[0].dataset;
                    if (typeof widgetId !== 'undefined') {
                        let newWidget = {
                            widget: widgetId,
                            width: itemData.gsWidth,
                            height: itemData.gsHeight,
                            x: itemData.gsX,
                            y: itemData.gsY
                        };
                        activeWidgets.push(newWidget);
                    }
                }
                widgetsToSave.activeWidgets = activeWidgets;
                widgetsToSave.activeWidgetList = getWidgetList();
                localStorage.setItem('widgets', JSON.stringify(widgetsToSave));
            }, 0);

        }

        function allowMoveAndResizeItems(mode) {
            let grid = mainGrid.data('gridstack');
            if (grid.grid && grid.grid.nodes.length > 0) {
                for (let i = 0; grid.grid.nodes.length > i; i++) {
                    let widgetName = grid.grid.nodes[i].el[0].children[0].dataset.widget;
                    widgetConfig.forEach((item) => {
                        if (widgetName === item.widget && (typeof item.isResizable === 'undefined' || !item.isResizable && !mode)) {
                            mainGrid.data('gridstack').resizable(grid.grid.nodes[i].el[0], mode);
                        }
                    });
                    mainGrid.data('gridstack').movable(grid.grid.nodes[i].el[0], mode);
                }
            }
        }

        // make draggable items in the widget list
        function widgetListCall() {
            $('.sidebar .grid-stack-item').draggable({
                revert: 'invalid',
                handle: '.grid-stack-item-content',
                scroll: false,
                appendTo: 'body'
            });
        }

        function getWidgetList() {
            let sidebarItems = $('.sidebar').children(),
                sidebarItemsKeys = [];
            if (sidebarItems && sidebarItems.length > 0) {
                for (let i = 0; sidebarItems.length > i; i++) {
                    sidebarItemsKeys.push(sidebarItems[i].children[0].dataset.widget);
                }
            }
            return sidebarItemsKeys;
        }

        function getActiveWidgets() {
            let
                gridItem = mainGrid.data("gridstack").grid.nodes,
                gridAllItems = [];
            for (let i = 0; gridItem.length > i; i++) {
                gridAllItems.push(gridItem[i].el[0].children[0].dataset.widget);
            }
            return gridAllItems;
        }

        function handleEvents() {
            mainGrid.on('dragstart', () => {
                widgetsBeforeRemove = mainGrid.data('gridstack').grid.nodes.map((item) => {
                    return item.el[0].children[0].dataset.widget
                });
            });
            mainGrid.on('dragstop', () => {
                saveWidgetItems();
            });
            mainGrid.on('gsresizestop', () => {
                saveWidgetItems();
            });
            mainGrid.on('added', (event, items) => {
                let grid = mainGrid.data('gridstack');
                if (isEditMode) {
                    for (let i = 0; i < items.length; i++) {
                        let el = items[i].el[0],
                            widgetId = el.children[0].getAttribute('data-widget'),
                            widget = widgetConfig.filter((item) => {
                                return item.widget === widgetId
                            })[0],
                            widgetsCount = widget.count;

                        // if multiple instances
                        let showInSidebarWithCount = typeof widgetsCount === "number" && widgetsCount > 1 && widgetsCount - getCountActiveIstances(widget.widget) > 0;

                        if (showInSidebarWithCount) {
                            $('.sidebar').append(gridItem(widget.widget, widget.title, (widgetsCount - getCountActiveIstances(widget.widget))));
                            widgetListCall();
                        } else if (typeof widgetsCount === "string" && widgetsCount === "unlimited") {
                            $('.sidebar').append(gridItem(widget.widget, widget.title));
                            widgetListCall();
                        }


                        el.children[0].children[0].innerHTML = '<div class="widget-loading-container"><div class="widget-loading">' +
                            '<div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div>';


                        // init
                        widgetConfig.forEach((item) => {
                            if (item.widget === widget.widget) {
                                let widgetProperties = Widget.widgetInitializer(widget);
                                grid.update(
                                    el,
                                    el.dataset.gsX,
                                    el.dataset.gsY,
                                    widgetProperties.config.width,
                                    widgetProperties.config.height
                                );
                                grid.minWidth(el, widgetProperties.config.minWidth);
                                grid.minHeight(el, widgetProperties.config.minHeight);
                                grid.resizable(el, widgetProperties.config.isResizable);
                                widgetProperties.initBase(el.children[0].children[0], clientId);
                            }
                        });
                    }
                    saveWidgetItems();
                } else {
                    grid.removeWidget(items[0].el[0], true)
                }
            });
            $('#editMode').on('change', (e) => {
                isEditMode = $(e.target).is(':checked');
                allowMoveAndResizeItems(isEditMode);
                $("#dashboardEditPanel").css('display', isEditMode ? 'block' : 'none');
                $("#grid1").toggleClass('edit-mode-on');
                $(".widget-icon-delete").css('display', isEditMode ? 'block' : 'none');
                document.dispatchEvent(new CustomEvent(isEditMode ? 'grid_editing_started' : 'grid_editing_finished'));
            });
            // remove
            $('#grid1').on("click", (e) => {
                if (e.target.classList[0] === $('div.widget-icon-delete')[0].classList[0]) {
                    let deletedWidget = $(e.target).parents('.grid-stack-item')[0].dataset.widget;
                    mainGrid.data("gridstack").removeWidget(
                        $(e.target).parents('.grid-stack-item')[0]
                    );
                    widgetConfig.forEach((item) => {
                        if (deletedWidget === item.widget) {
                            if (typeof item.count === "number" && item.count >= 1) {
                                let
                                    isAddDataCount = getCountActiveIstances(item.widget) < item.count && (item.count - getCountActiveIstances(item.widget)) !== 1,
                                    isAddFirstItem = (item.count - getCountActiveIstances(item.widget) === 1);

                                if (isAddDataCount) {
                                    let sidebarItems = $('.sidebar').children();
                                    if (sidebarItems && sidebarItems.length > 0) {
                                        for (let i = 0; sidebarItems.length > i; i++) {
                                            if (sidebarItems[i].children[0].dataset.widget === deletedWidget) {
                                                sidebarItems[i].children[0].children[0].dataset.widgetCount = item.count - getCountActiveIstances(item.widget);
                                            }
                                        }
                                    }
                                } else if (isAddFirstItem) {
                                    $('.sidebar').append(gridItem(item.widget, item.title));
                                }
                            } else if (typeof item.count === "string" && item.count === "unlimited") {
                            } else {
                                $('.sidebar').append(gridItem(item.widget, item.title));
                            }
                        }
                    });
                    saveWidgetItems();
                    // make draggable new appended item in the widget list
                    widgetListCall();
                }

            });
        }
    });
</script>
</body>

</html>